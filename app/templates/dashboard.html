{% extends "base.html" %}

{% block title %}Dashboard - Smart City{% endblock %}
{% block nav_dashboard %}active{% endblock %}
{% block page_title %}Resident Dashboard{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Welcome Card -->
    <div class="card welcome-card">
        <div class="welcome-content">
            <h2>Welcome back, {{ resident.name }}!</h2>
            <p>Manage your smart city devices and services from one place.</p>
        </div>
        <div class="welcome-stats">
            <div class="stat-item">
                <span class="stat-value">{{ devices|length }}</span>
                <span class="stat-label">Devices</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ notifications|length }}</span>
                <span class="stat-label">Alerts</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h3>Quick Actions</h3>
        </div>
        <div class="card-body">
            <div class="action-grid">
                <button class="action-btn" onclick="executeRoutine('sunrise')">
                    <span class="action-icon">ðŸŒ…</span>
                    <span>Sunrise Mode</span>
                </button>
                <button class="action-btn" onclick="executeRoutine('sunset')">
                    <span class="action-icon">ðŸŒ†</span>
                    <span>Sunset Mode</span>
                </button>
                <button class="action-btn" onclick="toggleAllLights('on')">
                    <span class="action-icon">ðŸ’¡</span>
                    <span>All Lights On</span>
                </button>
                <button class="action-btn" onclick="toggleAllLights('off')">
                    <span class="action-icon">ðŸŒ™</span>
                    <span>All Lights Off</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Device Control -->
    <div class="card device-card">
        <div class="card-header">
            <h3>Device Control</h3>
            <button class="btn btn-sm" onclick="refreshDevices()">Refresh</button>
        </div>
        <div class="card-body">
            <div class="device-list" id="deviceList">
                {% for device in devices %}
                <div class="device-item" data-id="{{ device.device_id }}">
                    <div class="device-info">
                        <span class="device-icon">
                            {% if device.type == 'StreetLight' %}ðŸ’¡
                            {% elif device.type == 'TrafficSignal' %}ðŸš¦
                            {% elif device.type == 'SecurityCamera' %}ðŸ“¹
                            {% else %}ðŸ“Ÿ{% endif %}
                        </span>
                        <div class="device-details">
                            <span class="device-name">{{ device.name }}</span>
                            <span class="device-type">{{ device.type }}</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <span class="status-badge {{ 'active' if device.status == 'active' else 'inactive' }}">
                            {{ device.status }}
                        </span>
                        <button class="btn btn-sm btn-success"
                            onclick="controlDevice('{{ device.device_id }}', 'on')">On</button>
                        <button class="btn btn-sm btn-danger"
                            onclick="controlDevice('{{ device.device_id }}', 'off')">Off</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Notifications -->
    <div class="card notifications-card">
        <div class="card-header">
            <h3>Recent Notifications</h3>
        </div>
        <div class="card-body">
            <div class="notification-list" id="notificationList">
                {% if notifications %}
                {% for notification in notifications[:5] %}
                <div class="notification-item {{ notification.type }}">
                    <span class="notification-icon">
                        {% if notification.type == 'security' %}ðŸ”’
                        {% elif notification.type == 'transaction' %}ðŸ’³
                        {% elif notification.type == 'emergency' %}ðŸš¨
                        {% else %}ðŸ“¢{% endif %}
                    </span>
                    <div class="notification-content">
                        <span class="notification-message">{{ notification.message }}</span>
                        <span class="notification-time">{{ notification.timestamp }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="empty-state">No notifications yet</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment Widget -->
    <div class="card payment-widget">
        <div class="card-header">
            <h3>Quick Payment</h3>
        </div>
        <div class="card-body">
            <form id="quickPaymentForm" onsubmit="processPayment(event)">
                <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="paymentAmount" class="form-input" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Payment Type</label>
                    <select id="paymentType" class="form-select">
                        <option value="fiat">Fiat (USD)</option>
                        <option value="bitcoin">Bitcoin</option>
                        <option value="ethereum">Ethereum</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="paymentDescription" class="form-input" placeholder="City service payment">
                </div>
                <button type="submit" class="btn btn-primary btn-block">Pay Now</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Device control
    async function controlDevice(deviceId, action) {
        try {
            const response = await fetch(`/api/device/${deviceId}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action })
            });
            const data = await response.json();
            if (data.success) {
                showToast(`Device ${action} successful`, 'success');
                refreshDevices();
            } else {
                showToast(data.error || 'Action failed', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    // Execute routine
    async function executeRoutine(routineType) {
        try {
            const response = await fetch(`/api/routine/${routineType}`, {
                method: 'POST'
            });
            const data = await response.json();
            if (data.success) {
                showToast(`${routineType} routine executed`, 'success');
                refreshDevices();
            }
        } catch (error) {
            showToast('Routine execution failed', 'error');
        }
    }

    // Process payment
    async function processPayment(event) {
        event.preventDefault();
        const amount = document.getElementById('paymentAmount').value;
        const type = document.getElementById('paymentType').value;
        const description = document.getElementById('paymentDescription').value;

        try {
            const response = await fetch('/api/payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: parseFloat(amount),
                    type,
                    currency: 'USD',
                    description
                })
            });
            const data = await response.json();
            if (data.success) {
                showToast(`Payment of $${amount} processed`, 'success');
                document.getElementById('quickPaymentForm').reset();
            } else {
                showToast(data.error || 'Payment failed', 'error');
            }
        } catch (error) {
            showToast('Payment processing error', 'error');
        }
    }

    // Toggle all lights
    async function toggleAllLights(action) {
        const devices = document.querySelectorAll('.device-item');
        for (const device of devices) {
            const id = device.dataset.id;
            if (device.querySelector('.device-type').textContent.includes('Light')) {
                await controlDevice(id, action);
            }
        }
    }

    // Refresh devices
    async function refreshDevices() {
        location.reload();
    }
</script>
{% endblock %}